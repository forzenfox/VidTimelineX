<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>竖向时间线 — 水墨风（Bilibili iframe）</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f8f8f6;
      --ink: #0a0a08;
      --muted: #666666;
      --accent: #111111;
      --card-bg: #ffffff;
    }
    html,body{height:100%; margin:0; font-family: "Noto Serif SC", serif; background: var(--bg); color:var(--ink); -webkit-font-smoothing:antialiased;}
    body{
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><filter id="g"><feTurbulence baseFrequency="0.8" numOctaves="1" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/></filter><rect width="100%" height="100%" filter="url(%23g)" opacity="0.02" fill="%23fff"/></svg>');
      background-blend-mode: multiply;
    }
    header{ padding:20px 24px; display:flex; align-items:center; gap:16px; border-bottom: 1px solid rgba(0,0,0,0.06); background: linear-gradient(180deg, rgba(0,0,0,0.02), transparent); position:sticky; top:0; z-index:50; }
    .logo{ font-family: "ZCOOL KuaiLe", "Noto Serif SC", serif; font-size:22px; letter-spacing:1px; color:var(--accent); }
    .subtitle{ color:var(--muted); font-size:13px; margin-left:auto; }

    .container{ max-width:1100px; margin:28px auto; padding:0 20px 80px; }

    .layout{ display:grid; grid-template-columns: 120px 1fr; gap:24px; align-items:start; }

    .timeline-column{ position:relative; padding-top:10px; }
    .timeline-line{ position:absolute; left:60px; top:10px; bottom:10px; width:4px; background: linear-gradient(to bottom, rgba(0,0,0,0.06), rgba(0,0,0,0.12)); border-radius:4px; }
    .timeline-point{ position:relative; width:120px; height:140px; display:flex; align-items:center; justify-content:center; cursor: pointer; }
    .dot{ width:22px; height:22px; border-radius:50%; background:var(--accent); border:3px solid var(--bg); box-shadow: 0 2px 0 rgba(0,0,0,0.15); }
    .dot.inactive{ background:#bfbfbf; }

    .cards{ display:flex; flex-direction:column; gap:28px; padding-top:6px; }
    .card{ display:flex; gap:18px; background:var(--card-bg); border-radius:12px; box-shadow: 0 8px 18px rgba(0,0,0,0.06); padding:14px; border-left:6px solid transparent; transition: transform .22s ease, border-left-color .18s ease; align-items:stretch; min-height:140px; }
    .card:hover{ transform: translateY(-6px); }
    .card.active{ border-left-color:var(--accent); box-shadow: 0 14px 30px rgba(0,0,0,0.08); }

    .thumb{ width:240px; max-width:34%; background:linear-gradient(180deg, rgba(0,0,0,0.04), rgba(0,0,0,0.02)); border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:13px; position:relative; overflow:hidden; }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

    .play-btn{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:56px; height:56px; border-radius:50%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; color:#fff; border: 2px solid rgba(255,255,255,0.08); box-shadow: 0 6px 18px rgba(0,0,0,0.35); }

    .card-body{ flex:1; display:flex; flex-direction:column; justify-content:space-between; }
    .meta{ font-size:13px; color:var(--muted); }
    .headline{ font-size:18px; color:var(--accent); margin:0 0 6px 0; line-height:1.2; font-weight:700; }
    .description{ color:var(--muted); font-size:14px; line-height:1.45; }
    .card-actions{ margin-top:10px; display:flex; gap:12px; align-items:center; }
    .btn{ padding:8px 12px; border-radius:8px; background:transparent; border:1px solid rgba(0,0,0,0.08); cursor:pointer; font-size:13px; color:var(--accent); }

    .player { position: sticky; top:72px; margin-bottom:18px; z-index:40; background: rgba(255,255,255,0.02); padding:12px; border-radius:10px; backdrop-filter: blur(4px); transition: all .18s ease; }
    .player .placeholder{ display:flex; align-items:center; justify-content:center; height:280px; border-radius:8px; background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01)); border:1px dashed rgba(0,0,0,0.04); color:var(--muted); }
    .player iframe, .player video{ width:100%; height:420px; border-radius:8px; border:none; background:#000; }

    @media (max-width:800px){
      .layout{ grid-template-columns: 1fr; gap:12px; }
      .timeline-column{ order:2; display:flex; justify-content:center; }
      .timeline-line{ left:50%; transform:translateX(-50%); width:6px; }
      .timeline-point{ width:100%; height:90px; justify-content:flex-start; padding-left:18px;}
      .dot{ margin-left: -8px; }
      .cards{ order:1; gap:18px; }
      .card{ flex-direction:column; }
      .thumb{ width:100%; max-width:100%; height:180px; }
      .player iframe, .player video{ height:260px; }
    }

    .ink-sep{ height:1px; background-image: linear-gradient(to right, rgba(0,0,0,0.18), rgba(0,0,0,0.02) 50%, rgba(0,0,0,0.18)); margin:18px 0; opacity:0.7; border-radius:1px; }

    footer { text-align:center; padding:34px 0 80px; color:var(--muted); font-size:13px; }
  </style>
</head>
<body>
  <header>
    <div class="logo">水墨时间线</div>
    <div class="subtitle">黑白水墨风 · 竖向时间线 · 移动端响应 · 点击卡片自动播放（Bilibili iframe）</div>
  </header>

  <div class="container">
    <div id="player" class="player" aria-live="polite">
      <div class="placeholder" id="player-placeholder">点击任意卡片以播放视频（B站 iframe）</div>
    </div>

    <div class="ink-sep" aria-hidden="true"></div>

    <div class="layout">
      <div class="timeline-column" id="timeline-col" aria-hidden="false">
        <div class="timeline-line" aria-hidden="true"></div>
      </div>

      <div class="cards" id="cards-col" role="list"></div>
    </div>

    <footer>本示例使用 Bilibili 官方嵌入播放器（player.bilibili.com）。</footer>
  </div>

  <script>
    // Load timeline.json directly
    const TIMELINE_PATHS = ['data/timeline.json'];

    async function fetchTimeline() {
      for (const p of TIMELINE_PATHS) {
        try {
          const res = await fetch(p);
          if (res.ok) {
            const json = await res.json();
            return json;
          }
        } catch (e) {
          // ignore and try next
        }
      }
      throw new Error('无法加载 timeline JSON（请通过 HTTP 服务器访问 data/ 目录）');
    }

    async function loadTimeline() {
      let data;
      try {
        data = await fetchTimeline();
      } catch (err) {
        document.getElementById('cards-col').innerHTML = '<p style="color:#900">加载 data/timeline.json 失败（请通过 HTTP 服务器访问）。</p>';
        return;
      }
      render(data);
    }

    function render(data) {
      const cardsCol = document.getElementById('cards-col');
      const timelineCol = document.getElementById('timeline-col');

      data.events.forEach((ev, idx) => {
        const point = document.createElement('div');
        point.className = 'timeline-point';
        point.dataset.index = idx;
        point.title = ev.text && ev.text.headline ? ev.text.headline : '事件';
        const dot = document.createElement('div');
        dot.className = 'dot';
        point.appendChild(dot);
        point.addEventListener('click', () => {
          scrollToCard(idx);
          activateCard(idx, true);
        });
        timelineCol.appendChild(point);

        const card = document.createElement('article');
        card.className = 'card';
        card.dataset.index = idx;
        card.setAttribute('role','listitem');

        const thumb = document.createElement('figure');
        thumb.className = 'thumb';
        if (ev.media && ev.media.thumbnail) {
          const img = document.createElement('img');
          img.src = ev.media.thumbnail;
          img.alt = ev.text && ev.text.headline ? ev.text.headline : '缩略图';
          thumb.appendChild(img);
        } else {
          const t = document.createElement('div');
          t.style.padding="12px";
          t.innerText = ev.media && ev.media.type && ev.media.type === 'mp4' ? '本地视频' : 'Bilibili 视频';
          thumb.appendChild(t);
        }
        const play = document.createElement('div');
        play.className = 'play-btn';
        play.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 3v18l15-9L5 3z" fill="#fff"/></svg>';
        thumb.appendChild(play);

        const body = document.createElement('div');
        body.className = 'card-body';

        const head = document.createElement('div');
        head.className = 'meta';
        head.innerText = formatDate(ev.start_date) || '';

        const title = document.createElement('h3');
        title.className = 'headline';
        title.innerText = ev.text && ev.text.headline ? ev.text.headline : '无标题';

        const desc = document.createElement('div');
        desc.className = 'description';
        desc.innerHTML = ev.text && ev.text.text ? ev.text.text : '';

        const actions = document.createElement('div');
        actions.className = 'card-actions';
        const btnPlay = document.createElement('button');
        btnPlay.className = 'btn';
        btnPlay.innerText = '播放';
        btnPlay.addEventListener('click', (e) => { e.stopPropagation(); activateCard(idx, true); });
        const btnMore = document.createElement('button');
        btnMore.className = 'btn';
        btnMore.innerText = '打开原页';
        btnMore.addEventListener('click', (e) => { e.stopPropagation(); if (ev.media && ev.media.url) window.open(ev.media.url, '_blank'); });

        actions.appendChild(btnPlay);
        actions.appendChild(btnMore);

        body.appendChild(head);
        body.appendChild(title);
        body.appendChild(desc);
        body.appendChild(actions);

        card.appendChild(thumb);
        card.appendChild(body);

        card.addEventListener('click', () => activateCard(idx, true));

        cardsCol.appendChild(card);
      });
    }

    function formatDate(sd) {
      if (!sd) return '';
      const y = sd.year || '';
      const m = sd.month ? ('0'+sd.month).slice(-2) : '';
      const d = sd.day ? ('0'+sd.day).slice(-2) : '';
      return [y, m, d].filter(Boolean).join('-');
    }

    function scrollToCard(idx) {
      const card = document.querySelector('.card[data-index="'+idx+'"]');
      if (!card) return;
      const top = card.getBoundingClientRect().top + window.scrollY - 120;
      window.scrollTo({top, behavior:'smooth'});
    }

    function extractBVID(url){
      if (!url) return null;
      const bvidMatch = url.match(/(BV[0-9A-Za-z]+)/);
      if (bvidMatch) return bvidMatch[1];
      const avMatch = url.match(/av(\d+)/i);
      if (avMatch) return { av: avMatch[1] };
      return null;
    }

    function activateCard(idx, autoplay=false) {
      const allCards = document.querySelectorAll('.card');
      allCards.forEach(c => c.classList.remove('active'));
      const active = document.querySelector('.card[data-index="'+idx+'"]');
      if (active) active.classList.add('active');

      const dots = document.querySelectorAll('.timeline-point .dot');
      dots.forEach(d => d.classList.add('inactive'));
      const dot = document.querySelector('.timeline-point[data-index="'+idx+'"] .dot');
      if (dot) { dot.classList.remove('inactive'); dot.style.background = 'var(--accent)'; }

      fetch('data/timeline.withthumbs.json').then(r=>r.ok? r.json() : fetch('data/timeline.json').then(r2=>r2.json())).then(data=>{
        const ev = data.events[idx];
        if (!ev || !ev.media) return;
        loadMediaIntoPlayer(ev.media, autoplay);
      }).catch(()=>{ /* ignore */ });
    }

    function loadMediaIntoPlayer(media, autoplay){
      const player = document.getElementById('player');
      player.innerHTML = '';

      const url = media.url || '';
      if (!url) {
        const ph = document.createElement('div');
        ph.className = 'placeholder';
        ph.innerText = '无媒体 URL';
        player.appendChild(ph);
        return;
      }

      if ((media.type && media.type.toLowerCase()==='mp4') || url.match(/\.mp4(\?.*)?$/i)) {
        const video = document.createElement('video');
        video.controls = true;
        video.playsInline = true;
        video.preload = 'metadata';
        video.src = url;
        if (autoplay) video.autoplay = true;
        player.appendChild(video);
        setTimeout(()=>video.scrollIntoView({behavior:'smooth', block:'center'}), 120);
        return;
      }

      if (url.includes('bilibili.com') || (media.type && media.type.toLowerCase()==='bilibili')) {
        const b = extractBVID(url);
        if (b && typeof b === 'string') {
          const iframe = document.createElement('iframe');
          const src = 'https://player.bilibili.com/player.html?bvid=' + encodeURIComponent(b) + '&page=1' + (autoplay ? '&autoplay=1' : '');
          iframe.src = src;
          iframe.allow = 'autoplay; fullscreen';
          iframe.style.height = '420px';
          player.appendChild(iframe);
          return;
        } else if (b && b.av) {
          const iframe = document.createElement('iframe');
          const src = 'https://player.bilibili.com/player.html?aid=' + encodeURIComponent(b.av) + (autoplay ? '&autoplay=1' : '');
          iframe.src = src;
          iframe.allow = 'autoplay; fullscreen';
          iframe.style.height = '420px';
          player.appendChild(iframe);
          return;
        } else {
          const a = document.createElement('div');
          a.className = 'placeholder';
          a.innerHTML = '<div style="padding:18px;">无法解析 B 站链接，<button class="btn" onclick="window.open(\''+url+'\',\'_blank\')">打开原页</button></div>';
          player.appendChild(a);
          return;
        }
      }

      const iframe = document.createElement('iframe');
      iframe.src = url;
      iframe.allow = 'autoplay; fullscreen';
      iframe.style.height = '420px';
      player.appendChild(iframe);
    }

    // highlight in-view card
    let ticking = false;
    window.addEventListener('scroll', () => {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(() => {
        const cards = document.querySelectorAll('.card');
        const offset = window.innerHeight / 3;
        let inViewIdx = null;
        cards.forEach(c => {
          const r = c.getBoundingClientRect();
          if (r.top < offset && r.bottom > offset) {
            inViewIdx = c.dataset.index;
          }
        });
        if (inViewIdx !== null) {
          const all = document.querySelectorAll('.card');
          all.forEach(a => a.classList.remove('active'));
          const active = document.querySelector('.card[data-index="'+inViewIdx+'"]');
          if (active) active.classList.add('active');
        }
        ticking = false;
      });
    }, {passive:true});

    // keyboard nav
    document.addEventListener('keydown', (e) => {
      if (e.key === 'j' || e.key === 'ArrowDown') {
        const active = document.querySelector('.card.active') || document.querySelector('.card');
        if (!active) return;
        const next = active.nextElementSibling;
        if (next) { next.scrollIntoView({behavior:'smooth', block:'center'}); activateCard(next.dataset.index, false); }
      } else if (e.key === 'k' || e.key === 'ArrowUp') {
        const active = document.querySelector('.card.active') || document.querySelector('.card');
        if (!active) return;
        const prev = active.previousElementSibling;
        if (prev) { prev.scrollIntoView({behavior:'smooth', block:'center'}); activateCard(prev.dataset.index, false); }
      }
    });

    loadTimeline();
  </script>
</body>
</html>